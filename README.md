# 🍲 Dish-Recognition 菜品识别系统

## 📌 项目目的
本项目基于 **PyTorch + ONNX**，结合 **MobileNetV2 轻量化模型**，实现了一个菜品识别系统。  
目标场景是食堂的 **留样称重**，系统通过识别托盘中的菜品来自动记录。  

设计思路：
- **服务端 (server)** 负责模型训练与导出  
- **客户端 (device)** 负责加载模型、录入菜品模板，并在实际使用时识别菜品  
- **模板机制**：客户端可录入多个同类菜品图片作为模板，识别时计算输入图片与模板的相似度  

---

## 📂 项目结构

```
dish-recognition/
│
├── server/              # 服务端（模型训练与导出）
│   ├── config.py        # 配置文件（数据集目录、模型目录、训练参数）
│   ├── train.py         # 训练脚本（带早停机制）
│   ├── main.py          # 联动训练与 ONNX 导出
│   └── models/          # (自动生成) 保存 .pth 和 .onnx 模型文件
│
├── device/              # 客户端（模板录入与识别）
│   ├── config.py        # 配置文件（模型路径、模板目录、阈值等）
│   ├── model.py         # 加载 ONNX 模型并提取特征向量
│   ├── templates.py     # 录入并管理模板
│   ├── recognize.py     # 菜品识别逻辑（余弦相似度 Top-k）
│   ├── main.py          # 交互入口（输入图片路径进行识别）
│   └── templates/       # (手动准备) 模板文件夹，每个菜品一个子文件夹
│
└── README.md            # 使用说明
```

---

## 📂 训练集文件结构

训练集采用 **ImageFolder 格式**，每个菜品一个子文件夹：  

```
datasets/
│
├── train/              # 训练集
│   ├── 鱼香肉丝/
│   │   ├── img1.jpg
│   │   ├── img2.jpg
│   │   └── ...
│   ├── 宫保鸡丁/
│   │   ├── img1.jpg
│   │   └── ...
│   └── ...
│
└── val/                # 验证集
    ├── 鱼香肉丝/
    │   ├── img_val1.jpg
    │   └── ...
    ├── 宫保鸡丁/
    │   ├── img_val1.jpg
    │   └── ...
    └── ...
```

要求：
- `train/` 与 `val/` 下子文件夹名称必须一致（即类别名）
- 每类至少包含若干图片（推荐 **20+ 张**）

---

## 📂 模板文件结构

客户端录入时使用的模板文件夹，结构如下：  

```
templates/
│
├── 鱼香肉丝/
│   ├── template1.jpg
│   ├── template2.jpg
│   └── ...
│
├── 宫保鸡丁/
│   ├── template1.jpg
│   └── ...
│
└── ...
```

要求：
- 每个菜品一个文件夹，文件夹名即为菜品名  
- 文件夹下可存放多张模板图片  

---

## 🚀 使用方法

### 1. 准备数据
- 将训练集放到 `datasets/` 目录下，保证有 `train/` 和 `val/`  
- 将模板集放到 `device/templates/` 下，每个菜品一个文件夹  

### 2. 修改配置
- `server/config.py`  
  - `DATASET_DIR` → 训练集目录  
  - `MODEL_DIR` → 模型保存目录  
  - `NUM_EPOCHS` → 最大训练轮数  
  - `PATIENCE` → 早停容忍次数  

- `device/config.py`  
  - `MODEL_PATH` → 指向导出的 `.onnx` 模型  
  - `TEMPLATE_DIR` → 模板目录  
  - `SIMILARITY_THRESHOLD` → 相似度阈值  

### 3. 训练与导出模型（服务端）
```bash
cd server
python main.py
```

执行后会：
- 训练模型并保存 `mobilenet_classifier.pth`  
- 自动导出 `mobilenet_feature_extractor.onnx`  

### 4. 客户端识别
```bash
cd device
python main.py
```

菜单示例：
```
=== 🍲 菜品识别系统 ===

操作菜单：
1. 输入图片绝对路径进行识别
2. 查看已加载的模板
3. 退出
```

识别结果示例：
```
✅ 识别结果（Top-3 相似度）：
 1. 鱼香肉丝 | 相似度=0.919
 2. 宫保鸡丁 | 相似度=0.732
```

---

## 📌 注意事项
- 确保 **训练集与验证集无重复图片**，否则 Val Acc 会虚高  
- 模板图片最好与实际使用环境一致（拍摄角度、光照）  
- 可以调整 `SIMILARITY_THRESHOLD` 控制识别的严格程度（推荐 0.5~0.7）  

---

## 🏆 项目特点
- 轻量级（基于 MobileNetV2，适合部署在低性能设备）  
- 模板机制灵活（客户端可随时录入新菜品模板）  
- 可移植性强（训练与推理分离，客户端无需训练，仅需加载模型）  
